zerops:
  - setup: backend
    build:
      base:
        - bun@nightly
        - nodejs@latest
      os: ubuntu
      envVariables:
        NODE_ENV: production
        ACCESS_TOKEN: ${RUNTIME_ACCESS_TOKEN}
        DATABASE_URL: ${RUNTIME_DATABASE_URL}
        DIRECT_URL: ${RUNTIME_DIRECT_URL}
        PROJECT_ID: ${RUNTIME_PROJECT_ID}
        SITE_URL: ${RUNTIME_SITE_URL}
        LEMON_SQUEEZY_STORE_ID: ${RUNTIME_LEMON_SQUEEZY_STORE_ID}
        NMIT_LIFETIME_PRODUCT_VARIANT_ID: ${RUNTIME_NMIT_LIFETIME_PRODUCT_VARIANT_ID}
        NEXTAUTH_URL: ${RUNTIME_NEXTAUTH_URL}
      prepareCommands:
        - echo "Upgrading bun to 1.1.34"
        - bun upgrade
      buildCommands:
        - bun install
        - bun run postinstall
        - bun run validateEnv
        - bun x nx build:executable backend
        - ls apps/backend
      deployFiles:
        - apps/backend/dist
        - node_modules
      cache:
        - node_modules
        - bun.lockb

    run:
      base: ubuntu@latest
      os: ubuntu
      ports:
        - port: 3000
          httpSupport: true
      prepareCommands:
        - echo "Installing yt-dlp"
        - curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/bin/yt-dlp
        - chmod a+rx /usr/bin/yt-dlp  # Make executable
      start: apps/backend/dist/main

    deploy:
      readinessCheck:
        httpGet:
          path: /swagger
          port: 3000
